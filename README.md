<img src=".\目录.png">


智能体的架构

1. 核心框架
2. 架构设计
3. 关键组件
4. 工作流程

## 🏗️ 数据运维 Agent 架构详解

### 一、核心框架栈

| 框架/库 | 版本 | 用途 |
|---------|------|------|
| **LangChain** | 1.0+ | Agent 开发核心框架，提供工具管理、提示词编排 |
| **LangGraph** | 1.0+ | 构建有状态的 Agent 流程，支持记忆和对话管理 |
| **LangChain OpenAI** | - | 大语言模型调用封装（兼容 OpenAI 接口） |
| **豆包大模型** | doubao-seed-1-6-251015 | 提供理解和推理能力 |

---

### 二、整体架构设计

```
┌─────────────────────────────────────────────────────────┐
│                   用户交互层                              │
│            (对话输入 / 任务指令)                          │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│              Agent 核心层 (ReAct)                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │  LangGraph Agent (create_agent)                  │  │
│  │  - System Prompt (运维专家角色)                   │  │
│  │  - 推理引擎 (思维链 CoT)                          │  │
│  │  - 工具调度器 (自动选择合适工具)                   │  │
│  └──────────────────────────────────────────────────┘  │
└────────────────────┬────────────────────────────────────┘
                     │
        ┌────────────┼────────────┐
        │            │            │
┌───────▼────────┐ ┌▼──────────┐ ┌▼──────────────┐
│  工具层 (Tools) │ │  状态层    │ │  模型层 (LLM) │
│                │ │ (State)    │ │               │
│ ┌────────────┐ │ │ ┌────────┐ │ │ ┌──────────┐ │
│ │task_monitor│ │ │ │Messages│ │ │ │ ChatOpenAI││
│ │            │ │ │ │State   │ │ │ │          ││
│ └────────────┘ │ │ └────────┘ │ │ └──────────┘ │
│ ┌────────────┐ │ │  滑动窗口  │ │   豆包模型   │
│ │task_log    │ │ │  记忆管理  │ │              │
│ │_reader     │ │ └───────────┘ │ └────────────┘ │
│ └────────────┘ │               │                │
└────────────────┘ └───────────────┴────────────────┘
        │                                  │
        └──────────────┬───────────────────┘
                       │
┌──────────────────────▼───────────────────────┐
│              数据层                             │
│  - assets/task_data.json (任务数据)           │
│  - logs/*.log (任务日志)                      │
└──────────────────────────────────────────────┘
```

---

### 三、关键组件详解

#### 1️⃣ **Agent 核心层**

```python
# src/agents/agent.py
agent = create_agent(
    model=llm,              # 大语言模型（豆包）
    system_prompt=cfg.get("sp"),  # 系统提示词
    tools=[task_monitor, task_log_reader],  # 可用工具
    checkpointer=get_memory_saver(),  # 记忆管理
    state_schema=AgentState,  # 状态模式
)
```

**核心能力：**
- **ReAct 推理框架**：思维 → 行动 → 观察的循环
- **自动工具调度**：根据任务需求自动选择合适工具
- **上下文管理**：维护对话历史和任务状态

#### 2️⃣ **状态管理层**

```python
class AgentState(MessagesState):
    messages: Annotated[list[AnyMessage], _windowed_messages]
```

**记忆机制：**
- 使用 **滑动窗口策略**：保留最近 20 轮对话（40 条消息）
- 防止上下文过长导致性能下降
- 支持跨轮次的任务追踪

**持久化策略：**
```python
# 优先使用 PostgreSQL 持久化
# 降级使用内存存储 (MemorySaver)
get_memory_saver() → AsyncPostgresSaver | MemorySaver
```

#### 3️⃣ **工具层**

**任务监控工具** (`task_monitor`)
```python
@tool
def task_monitor(task_id: Optional[str] = None, 
                 status: Optional[str] = None) -> str:
    """
    查询批量任务状态
    - 支持按 task_id 查询单个任务
    - 支持按 status 筛选任务
    """
```

**日志读取工具** (`task_log_reader`)
```python
@tool
def task_log_reader(task_id: str, lines: int = 100) -> str:
    """
    读取任务执行日志
    - 提取错误信息和异常堆栈
    - 支持指定读取行数
    """
```

#### 4️⃣ **系统提示词**

```
# 角色定义
你是一位专业的数据运维专家...

# 工作流程
1. 任务状态概览
2. 异常任务深度分析
3. 生成运维报告
```

**作用：**
- 定义 Agent 的角色和能力边界
- 指导 Agent 如何使用工具
- 规范输出格式（运维报告模板）

---

### 四、ReAct 工作流程

```
用户: "生成运维报告"
   ↓
┌─────────────────────────────────┐
│  Think: 需要先查询任务状态       │
│  Action: 调用 task_monitor()    │
└───────────────┬─────────────────┘
                │
┌───────────────▼─────────────────┐
│  Observation: 获取到4个任务      │
│  - 1个成功, 1个失败...           │
└───────────────┬─────────────────┘
                │
┌───────────────▼─────────────────┐
│  Think: 发现失败任务 task_002    │
│  Action: 调用 task_log_reader() │
└───────────────┬─────────────────┘
                │
┌───────────────▼─────────────────┐
│  Observation: 读取到错误日志     │
│  NullPointerException...        │
└───────────────┬─────────────────┘
                │
┌───────────────▼─────────────────┐
│  Think: 分析异常原因并生成报告    │
│  Action: 直接输出 Markdown 报告  │
└─────────────────────────────────┘
```

---

整个架构遵循 **关注点分离** 原则，便于维护和扩展！